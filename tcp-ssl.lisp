; Copyright (c) 2014 Akamai Technologies, Inc. (MIT License)

;; Add & override some functions in CL-ASYNC-SSL
(in-package :cl-async-ssl)

(defun init-ssl-npn (type ssl-ctx npn)
  "Setup NPN (next protocol negotiation) on an SSL context.
Returns a cleanup closure to be called upon disconnect."
  (check-type npn list)
  (let ((spec-str (format nil "摸窿祜镳骘轭铕泔祆邈ㄣ镤瀛汨狎戾铉翳皓泔祆邈皓┅ㄥ汜箦豉疱ê箦蝣弪戾è铕瞽狎绛骘ㄣ骀楹骘蝈殓瞽犰祜Ж后趄蹉沆篌旌后弪鲥颦綮箦纛屮麴蝻麸泗┅铕瞽篝颦骘ㄣ骀楹骘蝈殓瞽篝蜷铉犰祜箴邈篝颟┅ㄣ骀楹鏖翳骘蝈殓瞽箪雉è沆篌旌轰狒沆篌旌红孱铕瞽狎绛骘ê篝蝓泗沆篌旌后弪鲥颦綮箦纛屮麴蝻麸泗┅箦翩沆篌旌轰狒铕瞽篝颦骘沆篌旌红孱戾铉翳箴邈篝颟┅ㄣ飓篌旌后箪泗箦舡铄舡痱雉矬徜鲥螋轶邃汊篌飙泗ㄣ骀楹汜祆忉汶沆篌旌红轶瓠箦蝣弪铄舡痱雉锃汊铕瞽狎绛骘灬礅溽īㄣ骀楹骘蝈殓瞽骝邋铕瞽狎绛骘ㄣ骀楹骘蝈殓瞽篝蜷铉骝邋铕瞽篝颦骘┅┅ê沆殄铘戾è铕瞽狎绛骘ㄣ骀楹骘蝈殓瞽犰祜Ж后趄蹉沆篌旌恒扉孱舡綮箦纛屮麴蝻麸泗┅铕瞽篝颦骘ㄣ骀楹骘蝈殓瞽篝蜷铉犰祜箴邈篝颟┅ㄣ骀楹鏖翳骘蝈殓瞽箪雉è沆篌旌轰狒沆篌旌红孱铕瞽狎绛骘ê篝蝓泗沆篌旌恒扉孱舡綮箦纛屮麴蝻麸泗┅箦翩沆篌旌轰狒铕瞽篝颦骘沆篌旌红孱戾铉翳箴邈篝颟┅ㄣ飓篌旌后箪泗箦舡铄舡痱雉锃箦戾泗汊篌飙泗沆篌旌邯篌飙珈镡犰泔铘屮舄ㄣ骀楹汜祆忉汶沆篌旌红轶瓠沆殄铘铄舡痱雉锃汊铕瞽狎绛骘灬礅溽īㄣ骀楹骘蝈殓瞽骝邋铕瞽狎绛骘ㄣ骀楹骘蝈殓瞽篝蜷铉骝邋铕瞽篝颦骘┅┅┅ㄤ彐躅轭轸篌飙箢豉疱篌飙泗箦蝣弪钺礤⒂弭躔游箦蝣弪钺礤殇孱糸骈汜糸镱镱犷佑泔铘屮舢义趱蝾沆遽铛沆矬躜麸忮汜祆邃躔镱溟筱镱铄泗ㄣ桢汶豉疱箦蝣弪钺礤篝蜷铉ㄥ汜箦豉疱换箦蝣弪铒轫痨屙孱翦ê沆殄铘戾è箢榄骘ㄣ骀楹骘蝈殓瞽犰祜Ж后趄蹉沆篌旌呼祗屮翥豇┅箢榄篝颦骘ㄣ骀楹骘蝈殓瞽篝蜷铉犰祜箦蝣弪钺礤┅ㄣ骀楹鏖翳骘蝈殓瞽箪雉è沆篌旌衡轱溴怩绌箢榄骘ê篝蝓泗沆篌旌呼祗屮翥豇┅换箦翩沆篌旌衡轱溴怩ㄣ骀楹铛祆痫轭翦颟换ㄣ飓篌旌后箪泗箦舡綮箦舡箦蝣弪钺礤汜祆忉汶篌飙泗ㄣ骀楹汜祆忉汶沆篌旌红轶瓠篌飙箦蝣弪钺礤汊┅换ㄣ飓篌旌后箪泗箦舡綮箦舡箦蝣弪钺礤狎篌飙泗箢榄骘换ㄣ飓篌旌后箪箦舡綮箦舡栾篝钺礤篌飙泗箢榄篝颦骘灬礅溽īㄣ骀楹骘蝈殓瞽骝邋箢榄骘ㄣ骀楹骘蝈殓瞽篝蜷铉骝邋箢榄篝颦骘┅┅┅换龄佑汰团匀夏犷娜辛伊陀脲疳蜥礤翦蝮ㄤ彐躅翥瓠篌飙箦蝣弪ㄢ轭洵徜潋弩痫螋蝈徜汊弼孱舡汊脲泔铑邈舡汊ㄢ徙腱镧暴篝蝈犴篌飙礤翳镤с飓篌旌后箪霾抄箦蝣弪礤翳镤沐螋殒殂狒脲疳篌黠蜾滂疳蜥眢铕瞟⒂翎螋悦扉篝孱弪犷黩狃轭泔黹铉泔铑邈糸镱轭犷佑栳钿戾虍义趱蝾翥瓠箦蝣弪镡赍泗麒殂汜忮沆矬邃鏖翳沆矬瀛翥瓠箦蝣弪涉秕铄邃箦戽箝珙邃沐螋脲麸翦篝鏖翳镳孱篌珏铗筢秕痣妁舶锤镳孱篌蝈铄脲痣妁秕沐螋蝈镳孱篌蛋蝈溽扯蛋轭沐螋蝈箝珙脲痣妁秕沐螋换磲脲篚蝈佑轶轭轸獒扉邃ㄣ飓篌旌孱篚蝈轭轸獒扉邃喉弭栾篌飙礤翳镤换泸遽翦翳箦蝣弪犷珧徕轸溽翎痫轭翦戾舄è箦蝣弪翥瓠箦蝣弪忾钿徜潋弩痫螋蝈徜汊弼孱舡汊恒镱铄泗汊泔铑邈舡汊衡徙腱镧忉汶祜后趄遽篝蝈犴┅ㄤ狒岘痫轭翦翥瓠箦蝣弪溽翎痫轭翦箦蝣弪┅换秭弪黩轸翳徙沐痿汜祆忉汶骝镯翥瓠徙沐痿汊翥瓠篌飙徙沐痿汊戾哄鲢镱铎轶翦铄颦箦舡汊翥瓠箦蝣弪箦蝣弪ㄣ骀楹汜祆忉汶翥瓠篌飙徙沐痿汊溽翎痫轭翦颟换泸遽翦箦蝣弪泔铘屮戾舄è篌飙泗ㄣ飓篌旌后箪泗铄ㄦ躅汜祆篌飙礤翳镤┅篌飙箦蝣弪ㄣ栳铉瀛沆狍箦蝣弪翥瓠篌飙箦蝣弪后箪泗篌飙泗┅换磲脲篚蝈殒翳弪轶沐螋疳篌黠蜾轸躞邃ㄣ飓篌旌瑚轸璀疱憝疳篌黠蜾疳篌黠蜾ㄣ飓篌旌后箪泗箦舡溴驷蹯舡疳篌麂汊篌飙泗ㄣ骀楹汜祆忉汶沆篌旌吼屙疳篌黠蜾汜祆忉汶┅换祜徜翳沐螋麒孱沐螋殒殂狒戾è蝈ㄣ骀楹骘蝈殓瞽骢钽犰⒂犹呙载啧箦咩弪糸骈汜翦咩栳轭哝殪澧吼镩铘弪篌飙泗后趄轭钺礤篝蜷铉沐螋殒殂狒濠洪铘┅躅戾篌蝈暴ㄥ蝌矧ㄦ矧磲铋⑴蝌矧轭轸獒扉轭沐螋殒殂狒搴岙灬篝篌飙弪蝻颟┅┅换祜徜翳痱轹狒脲麒孱脲戾è蝈ㄣ骀楹骘蝈殓瞽骢钽犰⒂犹呙载啧箦咝蜷鲠翦隋哝殪澧吼镩铘弪篌飙泗后趄轭钺礤篝蜷铉脲洪铘沆篌旌韩篌飙骈戾豉疱疱慝洪铘┅躅戾篌蝈暴ㄥ蝌矧ㄦ矧磲铋⑴蝌矧轭轸獒扉轭痱轹狒脲骈戾岙灬篝篌飙弪蝻颟┅┅┅换箦趱滂疳蜥眢麒孱滂疳蜥眢ㄣ飓篌旌洪铋舡滂疳蜥眢滂疳蜥眢┅换箦趱铄痱雉镢镬铄顼糸狒轱麒孱铕戾è铕瞽沆遽铛ㄩ铋舡篌飙铕后弪鲥篌飙泗铕瞟┅ㄡ滗弼孱舡祜镳屮轸汜祆忉汶铕瞽沆遽铛皓┅换徜牾篝翳溽翎痫轭翦颛溽翎忾ㄡ趑徙璀溽翎麸痫轭翦溽翎痫轭翦扉篝后弪鲥箦蝣弪恒豇篌飙泗┅篌飙箦蝣弪┅